#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"
source $DIR/functions.sh

hdtfile=$1
mapping=$2

# Create fifos
p1=$(mkfifo fd1)
p2=$(mkfifo fd2)
p3=$(mkfifo fd3)
p4=$(mkfifo fd4)
p5=$(mkfifo fd5)
p6=$(mkfifo fd6)
p7=$(mkfifo fd7)
p8=$(mkfifo fd8)

# Read knowledge graph and classify triples accordingly
lbzcat $mapping | get_all  \
  | tee >(proc_labels | parse_labels > fd1) \
        >(proc_literals | parse_literals > fd2) \
        >(proc_categories > fd3) \
        >(proc_similar > fd4) \
        >(proc_related > fd5) \
        >/dev/null &

# Read each fifo and parse the triples to json
cat < fd1 | tee fd6 fd7 fd8 > a&
cat < fd2 > b&
# These fields required to know the labels of other triples. Therefore
# we need fisrt to map URIs to labels.
awk -F'|' 'NR==FNR {m[$1]=$3;next};{print $1"|"m[$3]}' <(cat fd6) <(cat fd3) | parse_categories > c&
awk -F'|' 'NR==FNR {m[$1]=$3;next};{print $1"|"m[$3]}' <(cat fd7) <(cat fd4) | parse_similar > d&
awk -F'|' 'NR==FNR {m[$1]=$3;next};{print $1"|"$2"|"m[$3]}' <(cat fd8) <(cat fd5) | parse_related > e&

# Read all the pipes and create a single json document for each resource
wait $!
cat a b c d e \
  | parse_document 

# Remove fifos
rm fd1 fd2 fd3 fd4 fd5 fd6 fd7 fd8
